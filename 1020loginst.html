<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>學生登入</title>
    <!-- 最新編譯的 Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <!-- jQuery 庫 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- 最新編譯的 JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=login" />
    <link rel="stylesheet" href='http://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'>
    <script async src="https://cse.google.com/cse.js?cx=54360293f1a554acf"></script> <!-- PSE API -->
</head>

<body>
    <header class="header text-center ">
        <a href="http://127.0.0.1:5500/RollCall/homepage.html">
            <img src="/RollCall/images/newlogo.png" alt="Logo" class="img-fluid"><!--圖片要改-->
        </a>
    </header>
    <div class="container">
        <nav class="navbar navbar-expand-sm bg-light">
            <!-- Links -->
            <div class="container-fluid">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="http://127.0.0.1:5500/RollCall/homepage.html">
                            <img src="/RollCall/images/p12.png" class="img-fluid float-right"
                                style="width: 40px; height: 40px; margin-right: 45px;" alt="首頁">
                        </a>
                    </li>
                    <li class="nav-item mt-2">
                        <a class="nav-link" href="http://127.0.0.1:5500/RollCall/1020loginst.html" style="color: brown;">學生專區</a>
                    </li>
                    <li class="nav-item mt-2">
                        <a class="nav-link" href="http://127.0.0.1:5500/RollCall/1020loginte.html">教職員專區</a>
                    </li>
                </ul>
                <ul class="navbar-nav navbar-right">
                    <li class="nav-item">
                        <!-- Google Search Engine 的嵌入區域 -->
                        <div class="gcse-searchbox-only"></div> <!-- 搜尋框 -->
                    </li>
                </ul>
            </div>
        </nav>

        <!-- 登入按鈕區域 -->
        <div class="row justify-content-end mt-3">
            <div class="col-md-6 text-right">
                <!-- Button to Open the Modal or Log Out -->
                <button type="button" id="authButton"
                    class="btn btn-outline-secondary d-flex align-items-center ml-auto" data-toggle="modal"
                    data-target="#myModal">
                    <img src="/RollCall/images/p52.png" class="img-fluid" style="width: 35px; height: 35px; margin-top: 2%;"
                        alt="登入">
                    <span id="authButtonText">登入</span>
                </button>
            </div>
        </div>



        <!-- The Modal -->
        <div class="modal" id="myModal">
            <div class="modal-dialog">
                <div class="modal-content">

                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h4 class="modal-title">學生登入</h4>
                        <button type="button" class="close" id="closeModalButton" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <!-- Modal body -->
                    <div class="container mt-5">
                        <div class="row justify-content-center">
                            <div class="card mb-5">
                                <div class="card-body">
                                    <form id="loginForm">
                                        <div class="form-group">
                                            <label for="username">帳號</label>
                                            <div class="input-group">
                                                <input type="text" id="username" class="form-control" placeholder="帳號"
                                                    required>
                                                <div class="input-group-append">
                                                    <span class="input-group-text"><i class='bx bxs-user'></i></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="password">密碼</label>
                                            <div class="input-group">
                                                <input type="password" id="password" class="form-control"
                                                    placeholder="密碼" required>
                                                <div class="input-group-append">
                                                    <span class="input-group-text"><i
                                                            class='bx bxs-lock-alt'></i></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group form-check">
                                            <input type="checkbox" id="rememberMe" class="form-check-input">
                                            <label class="form-check-label" for="rememberMe">記住我</label>
                                            <a href="#" class="float-right" id="forgotPasswordLink">忘記密碼</a>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-block" id="login">登入</button>
                                    </form>
                                    <div class="text-center mt-3">
                                        <p>還沒有帳號?<a href="http://127.0.0.1:5500/RollCall/studentboardForm.html"
                                                id="register">註冊</a></p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-danger" id="closeModal">關閉</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>


        <!-- 忘記密碼 Modal -->
        <div class="modal" id="forgotPasswordModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">發送驗證碼</h4>
                        <button type="button" class="close" id="closeForgotPasswordModal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="forgotPasswordForm">
                            <div class="form-group">
                                <label for="forgotUsername">帳號</label>
                                <input type="text" id="forgotUsername" class="form-control" placeholder="請輸入您的帳號"
                                    required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">發送驗證碼</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 確認驗證碼 Modal -->
        <div class="modal" id="verifyCodeModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">確認驗證碼</h4>
                        <button type="button" class="close" id="closeVerifyCodeModal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="verifyCodeForm">
                            <div class="form-group">
                                <label for="verificationCode">驗證碼</label>
                                <input type="text" id="verificationCode" class="form-control" placeholder="請輸入驗證碼"
                                    required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">確認</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖片展示 -->
        <div class="row mt-4">
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/boradstudent.html">
                    <img src="/RollCall/images/學生公佈欄.jpg" class="img-fluid rounded-circle" alt="學生公佈欄">
                </a>
            </div>
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/homework_student.html">
                    <img src="/RollCall/images/學生作業.jpg" class="img-fluid rounded-circle" alt="學生作業">
                </a>
            </div>
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/st1023.html">
                    <img src="/RollCall/images/學生簽到.jpg" class="img-fluid rounded-circle" alt="學生簽到">
                </a>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/studentleave.html">
                    <img src="/RollCall/images/學生請假.jpg" class="img-fluid rounded-circle" alt="學生請假">
                </a>
            </div>
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/enrollment.html">
                    <img src="/RollCall/images/學生選課.jpg" class="img-fluid rounded-circle" alt="學生選課">
                </a>
            </div>
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/studentForm.html">
                    <img src="/RollCall/images/資料修改.jpg" class="img-fluid rounded-circle" alt="資料修改">
                </a>
            </div>
        </div>

        <!-- 新增功能區 -->
        <div class="row mt-4">
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/1023studentlearn.html">
                    <img src="/RollCall/images/課程進度管理.png" class="img-fluid rounded-circle" alt="課程進度管理"><!-- 新增功能 -->
                </a>
            </div>
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/chat.html">
                    <img src="/RollCall/images/學生聊天室.png" class="img-fluid rounded-circle" alt="學生聊天室"><!-- 新增功能 -->
                </a>
            </div>
        </div>



        <script>
            const loggedIn = localStorage.getItem("student_username");

            if (loggedIn) {
                document.getElementById("authButtonText").textContent = "登出";
                document.getElementById("authButton").removeAttribute("data-toggle");
                document.getElementById("authButton").removeAttribute("data-target");
                document.getElementById("authButton").addEventListener("click", function () {
                    localStorage.removeItem("student_username");
                    alert("已成功登出");

                    document.getElementById("authButtonText").textContent = "登入";
                    window.location.reload(); // 重新加載頁面
                });
            }
            // 將關閉模態框的邏輯放在一個函數中
            function closeModal() {
                document.getElementById("myModal").style.display = "none"; // 隱藏模態框
                window.location.reload();
            }

            // 為關閉按鈕添加事件處理程序
            document.getElementById("closeModal").addEventListener('click', closeModal);

            // 為右上角的關閉按鈕添加事件處理程序
            document.getElementById("closeModalButton").addEventListener('click', closeModal);


            document.querySelectorAll('.protected-link').forEach(link => {
                link.addEventListener('click', async function (event) {
                    // 檢查用戶是否已登入
                    // 隱藏模態框

                    if (!loggedIn) {
                        event.preventDefault(); // 阻止連結的默認行為
                        document.getElementById("myModal").style.display = "block"; // 顯示登入模態框

                        // 確保只添加一次 submit 事件處理器
                        const loginForm = document.getElementById("loginForm");
                        if (!loginForm.hasAttribute("data-listener")) {
                            loginForm.setAttribute("data-listener", "true");

                            loginForm.addEventListener("submit", async function (evt) {
                                evt.preventDefault();

                                const username = document.getElementById("username").value;
                                const password = document.getElementById("password").value;

                                // 檢查輸入框是否已填寫
                                if (!username || !password) {
                                    alert("請填寫帳號和密碼!");
                                    return;
                                }

                                try {
                                    // 向後端發送登入請求
                                    const loginResponse = await fetch('http://localhost:8080/students/login', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        credentials: 'include',  // 攜帶 cookie
                                        body: JSON.stringify({
                                            username: username,
                                            password: password
                                        })
                                    });

                                    if (loginResponse.ok) {
                                        // 儲存登入資訊到 localStorage
                                        localStorage.setItem("student_username", username);


                                        // 更新登入按鈕為 "登出"
                                        window.location.reload();

                                    } else if (loginResponse.status === 401) {
                                        alert("帳號或密碼不符合!");
                                    } else if (loginResponse.status === 404) {
                                        alert("使用者未找到!");
                                    } else if (loginResponse.status >= 500) {
                                        alert("伺服器錯誤, 請稍後再試");
                                    } else {
                                        alert("發現錯誤, 請稍後再試");
                                    }
                                } catch (error) {
                                    console.error("發生錯誤:", error);
                                    alert("發現錯誤, 請稍後再試");
                                }
                            });
                        }
                    }
                });
            });
            document.getElementById("loginForm").addEventListener("submit", async function (evt) {
                evt.preventDefault();

                const username = document.getElementById("username").value;
                const password = document.getElementById("password").value;

                // 檢查輸入框是否已填寫
                if (!username || !password) {
                    alert("請填寫帳號和密碼!");
                    return;
                }

                try {
                    // 向後端發送登入請求
                    const loginResponse = await fetch('http://localhost:8080/students/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',  // 確保跨域情況下攜帶 cookie
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    if (loginResponse.ok) {
                        // 儲存登入資訊到 localStorage
                        localStorage.setItem("student_username", username);


                        alert("登入成功!");
                        const loggedIn = localStorage.getItem("student_username");
                        if (loggedIn) {
                            document.getElementById("authButtonText").textContent = "登出";
                            document.getElementById("authButton").removeAttribute("data-toggle");
                            document.getElementById("authButton").removeAttribute("data-target");
                            document.getElementById("authButton").addEventListener("click", function () {
                                localStorage.removeItem("student_username");
                                alert("已成功登出");
                                document.getElementById("authButtonText").textContent = "登入";
                                window.location.reload(); // 重新加載頁面
                            });
                        }

                        // 隱藏 modal，檢查 jQuery 是否正確加載
                        if (typeof $ !== 'undefined') {
                            $('#myModal').modal('hide'); // 使用 jQuery 隱藏 modal
                        } else {
                            document.getElementById("myModal").style.display = "none"; // 原生 JavaScript 隱藏 modal
                        }
                        // 可以根據需求進行重定向，例如:
                        // window.location.href = "http://localhost:8080/demo/test";

                    } else if (loginResponse.status === 401) {
                        alert("帳號或密碼不符合!");
                    } else if (loginResponse.status === 404) {
                        alert("使用者未找到!");
                    } else if (loginResponse.status >= 500) {
                        alert("伺服器錯誤, 請稍後再試");
                    } else {
                        alert("發現錯誤, 請稍後再試");
                    }
                } catch (error) {
                    console.error("發生錯誤:", error);
                    alert("發現錯誤, 請稍後再試");
                }
            });


            // 忘記密碼表單提交事件處理
            document.getElementById("forgotPasswordForm").addEventListener("submit", function (event) {
                event.preventDefault(); // 防止表單默認提交行為

                const username = document.getElementById("forgotUsername").value; // 獲取用戶名
                alert("username: " + username);

                // 發送請求以獲取電子郵件並發送驗證碼
                fetch('http://localhost:8080/student/forgot/get-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username }) // 將用戶名發送到後端
                })
                    .then(response => {
                        if (response.ok) {
                            return response.text(); // 返回響應文本
                        } else {
                            throw new Error('User not found'); // 錯誤處理
                        }
                    })
                    .then(data => {
                        alert(data); // 顯示成功消息
                        $('#forgotPasswordModal').modal('hide'); // 隱藏忘記密碼 modal

                        // 顯示驗證碼 modal
                        $('#verifyCodeModal').modal('show'); // 確認驗證碼 modal 的 ID
                    })
                    .catch(error => {
                        alert(error.message); // 顯示錯誤消息
                    });
            });

            // 顯示忘記密碼 modal 的事件處理
            document.getElementById("forgotPasswordLink").addEventListener("click", function () {
                $('#myModal').modal('hide'); // 隱藏登入 modal
                $('#forgotPasswordModal').modal('show'); // 顯示忘記密碼 modal
            });

            // 隱藏忘記密碼 modal 的事件處理
            document.getElementById("closeForgotPasswordModal").addEventListener("click", function () {
                $('#forgotPasswordModal').modal('hide'); // 隱藏忘記密碼 modal
            });

            // 隱藏確認驗證碼 modal 的事件處理
            document.getElementById("closeVerifyCodeModal").addEventListener("click", function () {
                $('#verifyCodeModal').modal('hide'); // 隱藏確認驗證碼 modal
            });

            // 驗證碼表單提交事件處理
            document.getElementById("verifyCodeForm").addEventListener("submit", function (event) {
                event.preventDefault(); // 防止表單默認提交行為

                const verificationCode = document.getElementById("verificationCode").value; // 獲取驗證碼
                const username = document.getElementById("forgotUsername").value; // 獲取用戶名

                // 發送請求以確認驗證碼
                fetch('http://localhost:8080/student/forgot/verify-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username, verificationCode: verificationCode }) // 發送用戶名和驗證碼到後端
                })
                    .then(response => {
                        if (response.ok) {
                            alert("驗證碼正確，請進入更改密碼頁面。");
                            window.location.href = `resetStudent.html?username=${username}`; // 跳轉到更改密碼頁面並傳遞用戶名
                        } else {
                            throw new Error('驗證碼錯誤'); // 錯誤處理
                        }
                    })
                    .catch(error => {
                        alert(error.message); // 顯示錯誤消息
                    });
            });

        </script>

</body>
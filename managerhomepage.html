<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>教職員登入</title>
    <!-- 最新編譯的 Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <!-- jQuery 庫 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- 最新編譯的 JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=login" />
    <link rel="stylesheet" href='http://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'>
    <script async src="https://cse.google.com/cse.js?cx=54360293f1a554acf"></script> <!-- PSE API -->
</head>

<body>
    <header class="header text-center my-4">
        <a href="http://127.0.0.1:5500/homepage.html">
            <img src="/images/newlogo.png" alt="Logo" class="img-fluid"><!--圖片要改-->
        </a>
    </header>
    <div class="container">
        <nav class="navbar navbar-expand-sm bg-light">
            <!-- Links -->
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="http://127.0.0.1:5500/RollCall/homepage.html">
                            <img src="/images/p12.png" class="img-fluid float-right"
                                style="width: 40px; height: 40px; margin-right: 45px;" alt="首頁">
                        </a>
                    </li>
                    <li class="nav-item mt-2">
                        <a class="nav-link" href="http://127.0.0.1:5500/RollCall/1020loginst.html">學生專區</a>
                    </li>
                    <li class="nav-item mt-2">
                        <a class="nav-link" href="http://127.0.0.1:5500/RollCall/1020loginte.html">教職員專區</a>
                    </li>
                    <li class="nav-item mt-2">
                        <a class="nav-link" href="http://127.0.0.1:5500/RollCall/1020loginte.html" style="color: brown;">管理員專區</a>
                    </li>
                </ul>
                <ul class="navbar-nav navbar-right">
                    <li class="nav-item">
                        <div class="gcse-searchbox-only"></div> <!-- 搜尋框 -->
                    </li>
                </ul>
            </div>
        </nav>

        <!-- 登入按鈕區域 -->
        <div class="row justify-content-end mt-3">
            <div class="col-md-6 text-right">
                <button type="button" id="authButton"
                    class="btn btn-outline-secondary d-flex align-items-center ml-auto" data-toggle="modal"
                    data-target="#myModal">
                    <img src="/images/p52.png" class="img-fluid" style="width: 35px; height: 35px; margin-top: 2%;"
                        alt="登入">
                    <span id="authButtonText">登入</span>
                </button>
            </div>
        </div>

        <!-- The Modal -->
        <div class="modal" id="myModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">管理員登入</h4>
                        <button type="button" class="close" id="closeModalButton" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="container mt-5">
                        <div class="row justify-content-center">
                            <div class="card mb-5">
                                <div class="card-body">
                                    <form id="loginForm">
                                        <div class="form-group">
                                            <label for="username">帳號</label>
                                            <div class="input-group">
                                                <input type="text" id="username" class="form-control" placeholder="帳號"
                                                    required>
                                                <div class="input-group-append">
                                                    <span class="input-group-text"><i class='bx bxs-user'></i></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="password">密碼</label>
                                            <div class="input-group">
                                                <input type="password" id="password" class="form-control"
                                                    placeholder="密碼" required>
                                                <div class="input-group-append">
                                                    <span class="input-group-text"><i class='bx bxs-lock-alt'></i></span>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-block" id="login">登入</button>
                                    </form>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-danger" id="closeModal">關閉</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖片佈局 -->
        <div class="row mt-4">
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/managerstudent.html">
                    <img src="/images/學生管理.png" class="img-fluid rounded-circle" alt="學生管理">
                </a>
            </div>
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/managerteacher.html">
                    <img src="/images/教職員管理.png" class="img-fluid rounded-circle" alt="教職員管理">
                </a>
            </div>
            <div class="col-md-4 mb-4">
                <a class="protected-link" href="http://127.0.0.1:5500/RollCall/manangerboard1025.html">
                    <img src="/images/公佈欄管理.png" class="img-fluid rounded-circle" alt="公佈欄管理">
                </a>
            </div>
        </div>

        <script>
            const loggedIn = localStorage.getItem("manager_username");

            if (loggedIn) {
                document.getElementById("authButtonText").textContent = "登出";
                document.getElementById("authButton").removeAttribute("data-toggle");
                document.getElementById("authButton").removeAttribute("data-target");
                document.getElementById("authButton").addEventListener("click", function () {
                    localStorage.removeItem("manager_username");
                    localStorage.removeItem("manager_status");
                    alert("已成功登出");
                    window.location.reload();
                });
            }

            function closeModal() {
                document.getElementById("myModal").style.display = "none";
                window.location.reload();
            }

            document.getElementById("closeModal").addEventListener('click', closeModal);
            document.getElementById("closeModalButton").addEventListener('click', closeModal);

            document.querySelectorAll('.protected-link').forEach(link => {
                link.addEventListener('click', function (event) {
                    if (!localStorage.getItem("manager_username") || localStorage.getItem("manager_status") !== "manager") {
                        event.preventDefault(); 
                        alert("您無權限訪問此功能，請使用管理員帳號登入。");
                        document.getElementById("myModal").style.display = "block";
                    }
                });
            });

            
           document.getElementById("loginForm").addEventListener("submit", async function (evt) {
            evt.preventDefault();

             const username = document.getElementById("username").value;
             const password = document.getElementById("password").value;

    if (!username || !password) {
        alert("請填寫帳號和密碼!");
        return;
    }

    try {
        const loginResponse = await fetch('http://localhost:8080/teachers/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                username: username,
                password: password
            })
        });

        const contentType = loginResponse.headers.get("content-type");
        let userData;

        if (loginResponse.ok) {
            if (contentType && contentType.includes("application/json")) {
                userData = await loginResponse.json();
            } else {
                // 如果回應不是 JSON 格式，作為文字來處理
                const textResponse = await loginResponse.text();
                if (textResponse.trim().toLowerCase() === "login successful") {
                    userData = { status: "manager" }; // 假設這是管理員
                } else {
                    alert(textResponse);
                    return;
                }
            }

            // 確保只有 status 為 "manager" 的教師才能登入
            if (!userData || userData.status !== 'manager') {
                alert("您無權限進入此區域，請使用管理員帳號登入。");
                return;
            }

            localStorage.setItem("manager_username", username);
            localStorage.setItem("manager_status", userData.status);

            alert("登入成功!");
            window.location.reload();

        } else if (loginResponse.status === 401) {
            alert("帳號或密碼不符合!");
        } else if (loginResponse.status === 404) {
            alert("使用者未找到!");
        } else if (loginResponse.status >= 500) {
            alert("伺服器錯誤, 請稍後再試");
        } else {
            alert("發現錯誤, 請稍後再試");
        }
    } catch (error) {
        console.error("發生錯誤:", error);
        alert("發現錯誤, 請稍後再試");
    }
});


        </script>

</body>

</html>

